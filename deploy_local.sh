#!/bin/bash

# Set environment variables
export SSH_PRIVATE_KEY="-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----"
export SERVER_IP="34.70.252.31"
export SERVER_USER="nwplustv"

# Create the private key file
echo "$SSH_PRIVATE_KEY" > private_key
chmod 600 private_key

# Copy files to the server
scp -i private_key -r . $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/fastapi-book-project

# Connect to the server and deploy
ssh -i private_key $SERVER_USER@$SERVER_IP << 'EOF'
  cd /home/$SERVER_USER/fastapi-book-project
  python -m venv venv
  source venv/bin/activate
  pip install -r requirements.txt
  nohup uvicorn main:app --host 0.0.0.0 --port 8000 &
EOF